{"componentChunkName":"component---src-templates-blog-template-js","path":"/django-cloudwatch","result":{"data":{"markdownRemark":{"html":"<p>This post describes how to get Django log messages into Cloudwatch. We'll configure a Cloudwatch log handler, and then outfit a DRF view to log a message to our Cloudwatch stream when a new object is created. This mimics a recent practical use case I encountered: Logging every request to a public API endpoint in Cloudwatch to aid in debugging. Let's get into it!</p>\n<p><strong><a href=\"https://gitlab.com/jordanahaines/public-projects-and-wiki/-/tree/blog_posts/cloudwatch/projects/django-starter-project\">Complete Demo Code</a></strong> </p>\n<p><a href=\"https://dev.to/jordanahaines/django-and-cloudwatch-logging-in-a-place-you-can-see-3bc7\">Cross-Posted on Dev.to</a> â€¢ <a href=\"https://tldlife.com/get-your-django-logs-into-cloudwatch-1d0911f55b8f\">Cross-Posted on Medium</a></p>\n<h3>Setup Cloudwatch - Copy AWS credentials</h3>\n<p>This post will not go into detail on setting up an AWS account. From AWS, you'll need the Access Key and ID for a user with write access to Cloudwatch logs. I'd recommend <em>not</em> using account you use to login to AWS. Instead, create an IAM user who we can grant Cloudwatch write access to. I tend to create separate users for dev, staging, and (especially) production environments for security and to aid in tracking down issues. At the end of the day, you'll need to make sure the IAM user you're using has the <em>CloudWatchLogsFullAccess</em> permission, and you'll want to copy both the <em>Access Key ID</em> and <em>Access Key Secret</em> for an access key for your user (click Create access key if you need new credentials)</p>\n<h3>Configure Django Logging</h3>\n<p>We are going to override the <a href=\"https://docs.djangoproject.com/en/3.0/topics/logging/#configuring-logging\">Django Logging setting</a> to create a new logger, handler, and formatter to get our log messages into Cloudwatch.</p>\n<ol>\n<li>Install the python packages we need (<a href=\"https://boto3.amazonaws.com/v1/documentation/api/latest/index.html\">boto3</a> to interact with the AWS API, and <a href=\"https://pypi.org/project/watchtower/\">Watchtower</a> to get push logs to Watchtower, specifically). Run <code class=\"language-text\">pip install watchtower boto3</code> (you're running in a <a href=\"https://tutorial.djangogirls.org/en/django_installation/\">virtual environment</a>, right?).</li>\n<li>In your settings file, instantiate a Boto3 session that Watchtower can use to connect to your AWS Cloudwatch account. In this example, I've put my AWS access key ID and Secret in the <code class=\"language-text\">AWS_ID</code> and <code class=\"language-text\">AWS_KEY</code> environmental variables.</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> boto3<span class=\"token punctuation\">.</span>session <span class=\"token keyword\">import</span> Session\n<span class=\"token comment\"># ...</span>\nCLOUDWATCH_AWS_ID <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>environ<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'AWS_ID'</span><span class=\"token punctuation\">)</span>\nCLOUDWATCH_AWS_KEY <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>environ<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'AWS_KEY'</span><span class=\"token punctuation\">)</span>\nAWS_DEFAULT_REGION <span class=\"token operator\">=</span> <span class=\"token string\">'us-west-2'</span> <span class=\"token comment\"># Be sure to update with your AWS region</span>\nlogger_boto3_session <span class=\"token operator\">=</span> Session<span class=\"token punctuation\">(</span>\n    aws_access_key_id<span class=\"token operator\">=</span>CLOUDWATCH_AWS_ID<span class=\"token punctuation\">,</span>\n    aws_secret_access_key<span class=\"token operator\">=</span>CLOUDWATCH_AWS_KEY<span class=\"token punctuation\">,</span>\n    region_name<span class=\"token operator\">=</span>AWS_DEFAULT_REGION<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<ol start=\"3\">\n<li>Define new <code class=\"language-text\">LOGGING</code> settings in your Django settings file. Here's the complete <code class=\"language-text\">LOGGING</code> settings you'll want to add (<a href=\"https://gitlab.com/jordanahaines/public-projects-and-wiki/-/blob/blog_posts/cloudwatch/projects/django-starter-project/demoschool/settings.py\">example</a>):</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">LOGGING <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"version\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"disable_existing_loggers\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"formatters\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"aws\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"format\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"%(asctime)s [%(levelname)-8s] %(message)s [%(pathname)s:%(lineno)d]\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"datefmt\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"%Y-%m-%d %H:%M:%S\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"handlers\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"watchtower\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"level\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"INFO\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"class\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"watchtower.CloudWatchLogHandler\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token comment\"># From step 2</span>\n            <span class=\"token string\">\"boto3_session\"</span><span class=\"token punctuation\">:</span> logger_boto3_session<span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"log_group\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"CWOSLogs\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token comment\"># Different stream for each environment</span>\n            <span class=\"token string\">\"stream_name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"logs\"</span></span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"formatter\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"aws\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"console\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"class\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"logging.StreamHandler\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"formatter\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"aws\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"loggers\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\"># Use this logger to send data just to Cloudwatch</span>\n        <span class=\"token string\">\"watchtower\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"level\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"INFO\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"handlers\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"watchtower\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"propogate\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Let's break this down.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token string\">\"formatters\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"aws\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"format\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"%(asctime)s [%(levelname)-8s] %(message)s [%(pathname)s:%(lineno)d]\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"datefmt\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"%Y-%m-%d %H:%M:%S\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>This adds a new <em>formatter</em> which defines how our logged messages will appear in Cloudwatch. This formatter ensures the time and log level are in the title. Here is what the resulting display looks like in Cloudwatch: <code class=\"language-text\">2020-05-24 15:26:48 [INFO ] Student Created: Arya Start (PK: 4) [.../django-starter-project/schoolusers/views.py:23]</code></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&quot;handlers&quot;: {...}</code></pre></div>\n<p>This section creates a new handler that will forward all logs of level <code class=\"language-text\">INFO</code> or higher, to the designated <code class=\"language-text\">loggers</code> (in this case, just our <code class=\"language-text\">watchtower</code> logger). The <code class=\"language-text\">log_group</code> key indicates the log group, and <code class=\"language-text\">stream_name</code> the Cloudwatch stream within that group, that our message will appear under. Finally, we specify the <code class=\"language-text\">aws</code> formatter which dictates how logged messages will appear</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token string\">\"loggers\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\"># Use this logger to send data just to Cloudwatch</span>\n        <span class=\"token string\">\"watchtower\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"level\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"INFO\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"handlers\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"watchtower\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"propogate\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>This section defines a new logger for Cloudwatch. All messages of <code class=\"language-text\">level</code> or higher (that is, level \"INFO\") or higher, will be sent to the <code class=\"language-text\">watchtower</code> handler. The <code class=\"language-text\">propogate</code> property determines whether messages will be sent to additional loggers.</p>\n<h3>Posting a Log Message From a View</h3>\n<p>Alright, we've configured our Cloudwatch logger. Let's test it out. I added the following two lines to one of my views, specifically when a student is created in my school demo project (<a href=\"https://gitlab.com/jordanahaines/public-projects-and-wiki/-/blob/blog_posts/cloudwatch/projects/django-starter-project/schoolusers/views.py\">complete views code</a>):</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">logger <span class=\"token operator\">=</span> logging<span class=\"token punctuation\">.</span>getLogger<span class=\"token punctuation\">(</span><span class=\"token string\">\"watchtower\"</span><span class=\"token punctuation\">)</span>\nlogger<span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"Student Created: \\n\\n </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>student<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span></span><span class=\"token string\"> (PK: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>student<span class=\"token punctuation\">.</span>pk<span class=\"token punctuation\">}</span></span><span class=\"token string\">)\"</span></span><span class=\"token punctuation\">)</span> </code></pre></div>\n<p>I then test by posting to this view with <a href=\"https://insomnia.rest/\">Insomnia Rest Client</a>. For this post, I also include <a href=\"https://gitlab.com/jordanahaines/public-projects-and-wiki/-/blob/blog_posts/cloudwatch/projects/django-starter-project/schoolusers/tests/scripts.py\">example code</a> that executes a request that uses this view, and thus should post a log message to Cloudwatch if you've configured your logger properly.</p>\n<p>In my demo project, when a POST is made to create a new student, I see a message like the following appear within Cloudwatch ðŸ˜€: <img src=\"https://dev-to-uploads.s3.amazonaws.com/i/wvtkfqhc725cf07ztbuq.png\" alt=\"Cloudwatch log message example\"></p>\n<h3>Enriching your log messages</h3>\n<p>I lied - the example above is not the extent of the logging I do with Cloudwatch. Because we have apps running in separate environments for local development, staging, testing, and product, we break out the logs for each of these environments to make messages easier to find (and to potentially add alarms to the production logs). In case this is also useful to you, we do this by:</p>\n<ol>\n<li>Defining an <code class=\"language-text\">ENV</code> setting that describes what environment we're in. This setting can be set from an environmental variable, or you can use a different settings file for each environment to set a different value. In our logging configuration, we include <code class=\"language-text\">ENV</code> in the <code class=\"language-text\">stream_name</code> so that each environment has its own log stream within our Cloudwatch log group.</li>\n<li>We define an aws logging <code class=\"language-text\">filter</code> that attaches <code class=\"language-text\">ENV</code> to a new <code class=\"language-text\">env</code> property on the message. This was a key learning for me -- <strong>you can use a filter to add data to a log message*</strong>:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">CloudwatchLoggingFilter</span><span class=\"token punctuation\">(</span>logging<span class=\"token punctuation\">.</span>Filter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\" Filter which injects context for env on record \"\"\"</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> record<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        record<span class=\"token punctuation\">.</span>env <span class=\"token operator\">=</span> settings<span class=\"token punctuation\">.</span>ENV\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">True</span> <span class=\"token comment\"># All messages make it through filter</span></code></pre></div>\n<ol start=\"3\">\n<li>We use this new <code class=\"language-text\">env</code> property in the title of the message for good measure.</li>\n</ol>\n<p>This is the code you'll find in the <a href=\"https://gitlab.com/jordanahaines/public-projects-and-wiki/-/tree/blog_posts/cloudwatch/projects/django-starter-project\">demo code</a></p>\n<h2>An aside on Django Logging</h2>\n<p>As I dove into this topic, I found Django logging to be quite a bit more complex than expected. The <a href=\"https://docs.djangoproject.com/en/3.0/topics/logging/#configuring-logging\">Django Logging Documentation</a> does a great job of explaining how logging works, how to setup your own loggers, and how to get different types of log messages to different places. Below are my notes:</p>\n<p><strong>Overview</strong>: <strong>Loggers</strong> are buckets where messages (<strong>Log Records</strong>) are sent. Loggers have a Log Level (DEBUG, INFO, WARNING, ERROR, CRITICAL); Loggers ignore records with a log level below the logger's level.</p>\n<p>Loggers send messages (that they don't ignore) to one or more <strong>Handlers</strong>. Handlers determine what to do with a log record - like writing to console, a file or - as in our example above - to a log repository like CloudWatch. There is a many-to-many relationship between handlers and loggers, so the same handler can be re-used across many loggers. Handlers have their own log level, and ignore records below the handler's log level (allowing different forms of notification - based on record level - for the same logger).</p>\n<p>I know what you're thinking: This whole system is not nearly granular enough. Enter filters. <strong>Filters</strong> provide additional control over which log records make their way from a logger to a handler. Filters can alter the log level of a log record; they can also suppress log records based on their source or other metadata on the log record. Filters can be chained.</p>\n<h3>Big Revelation</h3>\n<p><strong>Filters can attach additional information to log records</strong> which can then be used in formatters to customize the display. I used this feature to attach a Django setting variable (<code class=\"language-text\">ENV</code>) to records, so the <code class=\"language-text\">ENV</code> is visible in the log record in CloudWatch.</p>\n<p>Finally, once a record makes its way to a handler and the record has a log level at or above that of the handler a <strong>formatter</strong> is used to determine how the record is written by the handler. A formatter is just a python formatting string that leverages the <a href=\"https://docs.python.org/3/library/logging.html#logrecord-attributes\">Log Record Attributes</a>.</p>\n<p>Cool? Cool. In summary:</p>\n<ol>\n<li>Log Record created. Sent to all loggers, but <em>ignored</em> by loggers w/Log Level above that of the log record.</li>\n<li>Filters (associated with each logger) are applied to determine which records actually get passed to handler(s).</li>\n<li>Records that aren't suppressed by filters get sent to all of the handlers on logger. Handlers ignore records below the handler's log level</li>\n<li>Handler uses formatter to determine what the record will look like when you read it. Handler writes the record (to a file, or console, or Cloudwatch, etc).</li>\n</ol>","frontmatter":{"date":"May 24, 2020","path":"/django-cloudwatch","title":"Django + Cloudwatch -- Logging in a place you can see","thumbnail":"/assets/django_cloudwatch.jpg"}}},"pageContext":{}}}